<!doctype html>
<html>
  <head>
    <title>Bimbus</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
    <style>
      .part {
        overflow-y: auto;
        height: calc(100vh - 3rem);
      }

      .hide {
        display: none;
      }

      .log {
        color: white;
        background-color: black;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row my-4">
        <div class="col-6">
          <div id="connectPart" class="part hide">
            <div class="form-group">
              <label for="token">Token</label>
              <input type="text" class="form-control" id="token" required>
              <small class="form-text text-muted">The JWT token used for authentication</small>
            </div>
            <div class="form-group">
              <label for="username">Username</label>
              <input type="text" class="form-control" id="username" required/>
            </div>
            <div class="form-group">
              <label for="opponent">Opponent</label>
              <input type="text" class="form-control" id="opponent" required/>
            </div>
            <button id="connectButton" class="btn btn-primary">Connect</button>
          </div>
          <div id="guessPart" class="part hide">
            <div class="form-group">
              <label for="guess">Guess</label>
              <input type="text" class="form-control" id="guess" placeholder="Guess the word">
            </div>
            <button id="guessButton" class="btn btn-primary">Guess</button>
            <button id="disconnectButton" class="btn btn-secondary">Disconnect</button>
          </div>
        </div>
        <div class="col-6 py-3 rounded part log" id="log"></div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script>
      const connectPart = document.getElementById('connectPart');
      const guessPart = document.getElementById('guessPart');
      let oldSocket;

      function openConnectPart() {
        connectPart.classList.remove('hide');
        guessPart.classList.add('hide');

        log('CLIENT', 'Please enter token and click connect...');

        document.getElementById('connectButton').onclick = async function () {
          this.disabled = true;

          const token = document.getElementById('token').value;
          const username = document.getElementById('username').value;
          const opponent = document.getElementById('opponent').value;

          const data = await fetch(`http://localhost:8000/users/${username}/games/${opponent}`, {
            method: 'GET',
            headers: new Headers({
              'Authorization': `Bearer ${token}`
            })
          }).then(response => response.json());

          if (!data.status.success) {
            log('CLIENT', 'No active game found via API...');
          } else {
            oldSocket = createSocket(data.data.roomId, token);
          }

          this.disabled = false;
        };
      }

      function openGuessPart() {
        connectPart.classList.add('hide');
        guessPart.classList.remove('hide');

        log('CLIENT', 'Allowing user to guess...');

        document.getElementById('disconnectButton').onclick = function () {
          oldSocket.disconnect();
        };
      }

      function createSocket(id, token) {
        const socket = io({
          auth: {
            token: `Bearer ${token}`
          }
        });

        socket.on('connect', () => {
          log('SERVER', 'Connected to server!');
          log('CLIENT', 'Sending game information to server...');

          socket.emit('roomInit', id);
        });

        socket.on('roomInitResponse', (data) => {
          if (data === true) {
            log('SERVER', 'Game found');

            openGuessPart();
          } else {
            log('SERVER', 'Game not found');
          }
        });

        socket.on('userJoined', (data) => {
          log('SERVER', `User ${data} joined!`);
        });

        socket.on('message', (data) => {
          log('SERVER', data);
        });

        socket.on('disconnect', () => {
          openConnectPart();
        });

        return socket;
      }

      function log(from, msg) {
        const date = new Date();

        document.getElementById('log').prepend(
          `[${date.getHours()}:${date.getMinutes()}:${date.getMilliseconds()}] [${from}] ${msg}`,
          document.createElement('br')
        );
      }

      openConnectPart();
    </script>
  </body>
</html>
